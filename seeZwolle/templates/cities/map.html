{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spatial Cities Map - Proximity Search</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
  />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="{% url 'city_list' %}">
        üìç Spatial Cities - Proximity Search
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="{% url 'city_list' %}">Cities List</a>
        <a class="nav-link active" href="{% url 'map_view' %}">Map View</a>
      </div>
    </div>
  </nav>

  <!-- Map Container -->
  <div id="map" style="height: calc(100vh - 56px);"></div>

  <!-- Proximity Search Controls -->
  <div class="proximity-controls">
    <h6 class="mb-3">üîç Proximity Search</h6>

    <!-- Search Mode Selection -->
    <div class="search-mode-selector">
      <div class="form-check">
        <input
          class="form-check-input"
          type="radio"
          name="searchMode"
          id="nearestMode"
          value="nearest"
          checked
        />
        <label class="form-check-label" for="nearestMode">
          Find 10 Nearest Cities
        </label>
      </div>
      <div class="form-check">
        <input
          class="form-check-input"
          type="radio"
          name="searchMode"
          id="radiusMode"
          value="radius"
        />
        <label class="form-check-label" for="radiusMode">
          Find Cities Within Radius
        </label>
      </div>
    </div>

    <!-- Toggle Button -->
    <button
      id="toggle-proximity"
      class="btn btn-primary btn-sm mb-2 w-100"
    >
      Enable Search Mode
    </button>

    <!-- Search Controls -->
    <div id="search-controls" class="search-controls">
      <!-- Radius input (shown only in radius mode) -->
      <div id="radius-control" style="display: none;">
        <label for="radius-input" class="form-label small">Radius (km):</label>
        <input
          type="number"
          id="radius-input"
          class="form-control form-control-sm mb-2"
          placeholder="Enter radius"
          value="100"
          min="1"
          max="20000"
        />
      </div>

      <!-- Action buttons -->
      <div class="d-flex gap-2">
        <button
          id="clear-search"
          class="btn btn-outline-secondary btn-sm flex-fill"
        >
          Clear Results
        </button>
        <button
          id="zoom-to-results"
          class="btn btn-outline-info btn-sm flex-fill"
          style="display: none;"
        >
          Zoom to Fit
        </button>
      </div>
    </div>

    <small class="text-muted d-block mt-2">
      <i class="fas fa-info-circle"></i> Click anywhere on the map to search
    </small>
  </div>

  <!-- Results Panel -->
  <div id="results-panel" class="results-panel">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0" id="results-title">Search Results</h6>
        <button id="close-results" class="btn-close"></button>
      </div>
      <div id="results-content" class="card-body">
        <!-- Results will be populated here -->
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Initialize map
    let map = L.map("map").setView([54.5, 15.2], 4);

    // Add tile layer
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
    }).addTo(map);

    // Proximity search variables
    let proximityMode = false;
    let searchMarker = null;
    let resultMarkers = [];
    let radiusCircle = null;
    let allCitiesLayer = L.layerGroup().addTo(map);

    // Search mode
    let currentSearchMode = "nearest";

    // Load initial cities
    loadCities();

    // Event Listeners
    document
      .getElementById("toggle-proximity")
      .addEventListener("click", toggleProximityMode);
    document
      .getElementById("clear-search")
      .addEventListener("click", clearSearch);
    document
      .getElementById("zoom-to-results")
      .addEventListener("click", zoomToResults);
    document.getElementById("close-results").addEventListener("click", () => {
      document.getElementById("results-panel").style.display = "none";
    });

    // Search mode radio buttons
    document.querySelectorAll('input[name="searchMode"]').forEach((radio) => {
      radio.addEventListener("change", (e) => {
        currentSearchMode = e.target.value;
        updateSearchControls();
      });
    });

    // Map click handler
    map.on("click", function (e) {
      if (proximityMode) {
        if (currentSearchMode === "nearest") {
          performNearestSearch(e.latlng.lat, e.latlng.lng);
        } else {
          performRadiusSearch(e.latlng.lat, e.latlng.lng);
        }
      }
    });

    // Functions
    function toggleProximityMode() {
      proximityMode = !proximityMode;
      const btn = document.getElementById("toggle-proximity");
      const controls = document.getElementById("search-controls");

      if (proximityMode) {
        btn.textContent = "Disable Search Mode";
        btn.className = "btn btn-danger btn-sm mb-2 w-100";
        controls.style.display = "block";
        map.getContainer().style.cursor = "crosshair";
        updateSearchControls();
      } else {
        btn.textContent = "Enable Search Mode";
        btn.className = "btn btn-primary btn-sm mb-2 w-100";
        controls.style.display = "none";
        map.getContainer().style.cursor = "";
        clearSearch();
      }
    }

    function updateSearchControls() {
      const radiusControl = document.getElementById("radius-control");
      radiusControl.style.display =
        currentSearchMode === "radius" ? "block" : "none";
    }

    async function loadCities() {
      try {
        console.log("Loading all cities...");
      } catch (error) {
        console.error("Error loading cities:", error);
      }
    }

    async function performNearestSearch(lat, lng) {
      clearSearch();
      addSearchMarker(lat, lng, "Nearest Cities Search");

      try {
        showLoadingState(true);

        const response = await fetch("/query/api/nearest/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
          },
          body: JSON.stringify({ lat, lng }),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        displayNearestResults(data);
      } catch (error) {
        console.error("Error:", error);
        showError("Error performing nearest cities search: " + error.message);
      } finally {
        showLoadingState(false);
      }
    }

    async function performRadiusSearch(lat, lng) {
      clearSearch();
      const radiusKm =
        parseFloat(document.getElementById("radius-input").value) || 100;

      if (radiusKm <= 0 || radiusKm > 20000) {
        showError("Please enter a valid radius between 1 and 20000 km");
        return;
      }

      addSearchMarker(lat, lng, `Radius Search (${radiusKm} km)`);
      addRadiusCircle(lat, lng, radiusKm);

      try {
        showLoadingState(true);

        const response = await fetch("/query/api/radius/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
          },
          body: JSON.stringify({ lat, lng, radius_km: radiusKm }),
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        displayRadiusResults(data);
      } catch (error) {
        console.error("Error:", error);
        showError("Error performing radius search: " + error.message);
      } finally {
        showLoadingState(false);
      }
    }

    function addSearchMarker(lat, lng, popupText) {
      searchMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: "search-marker",
          html: '<div class="search-marker">üìç</div>',
          iconSize: [30, 30],
          iconAnchor: [15, 15],
        }),
      }).addTo(map);

      searchMarker
        .bindPopup(
          `<strong>${popupText}</strong><br>Lat: ${lat.toFixed(
            6
          )}<br>Lng: ${lng.toFixed(6)}`
        )
        .openPopup();
    }

    function addRadiusCircle(lat, lng, radiusKm) {
      radiusCircle = L.circle([lat, lng], {
        radius: radiusKm * 1000, // Convert km to meters
        fillColor: "#007bff",
        fillOpacity: 0.1,
        color: "#007bff",
        weight: 2,
        className: "radius-circle",
      }).addTo(map);
    }

    function displayNearestResults(data) {
      const resultsPanel = document.getElementById("results-panel");
      const resultsContent = document.getElementById("results-content");
      const resultsTitle = document.getElementById("results-title");

      data.nearest_cities.forEach((city) => {
        const marker = L.marker([city.coordinates.lat, city.coordinates.lng], {
          icon: L.divIcon({
            className: "result-marker",
            html: `<div class="result-marker">${city.rank}</div>`,
            iconSize: [28, 28],
            iconAnchor: [14, 14],
          }),
        }).addTo(map);

        marker.bindPopup(`
          <div class="popup-content">
            <strong>#${city.rank} ${city.name}</strong><br>
            <span class="text-muted">${city.country}</span><br>
            <strong>Population:</strong> ${city.population.toLocaleString()}<br>
            <strong>Distance:</strong> ${city.distance_km} km<br>
            ${city.description ? `<p class="mt-2 small">${city.description}</p>` : ""}
          </div>
        `);

        resultMarkers.push(marker);
      });

      resultsTitle.textContent = `Nearest Cities (${data.total_found})`;
      resultsContent.innerHTML = `
        <div class="search-info mb-3">
          <strong>Search Point:</strong> ${data.search_point.lat.toFixed(
            4
          )}, ${data.search_point.lng.toFixed(4)}<br>
          <strong>Found:</strong> ${data.total_found} nearest cities
        </div>
        <div class="list-group list-group-flush">
          ${data.nearest_cities
            .map(
              (city) => `
            <div class="list-group-item" onclick="zoomToCity(${city.coordinates.lat}, ${city.coordinates.lng})">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>#${city.rank} ${city.name}</strong><br>
                  <small class="text-muted">${city.country}</small><br>
                  <small>Pop: ${city.population.toLocaleString()}</small>
                </div>
                <span class="distance-badge">${city.distance_km} km</span>
              </div>
            </div>`
            )
            .join("")}
        </div>
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-primary" onclick="exportResults('nearest')">
            Export Results
          </button>
        </div>
      `;

      showResults();
    }

    function displayRadiusResults(data) {
      const resultsPanel = document.getElementById("results-panel");
      const resultsContent = document.getElementById("results-content");
      const resultsTitle = document.getElementById("results-title");

      data.cities.forEach((city) => {
        const marker = L.marker([city.coordinates.lat, city.coordinates.lng], {
          icon: L.divIcon({
            className: "result-marker",
            html: `
              <div style="background:#28a745;color:white;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.4);font-size:10px;"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12],
          }),
        }).addTo(map);

        marker.bindPopup(`
          <div class="popup-content">
            <strong>${city.name}</strong><br>
            <span class="text-muted">${city.country}</span><br>
            <strong>Population:</strong> ${city.population.toLocaleString()}<br>
            <strong>Distance:</strong> ${city.distance_km} km<br>
            ${city.description ? `<p class="mt-2 small">${city.description}</p>` : ""}
          </div>
        `);

        resultMarkers.push(marker);
      });

      resultsTitle.textContent = `Cities in ${data.radius_km}km Radius`;
      resultsContent.innerHTML = `
        <div class="search-info mb-3">
          <strong>Search Point:</strong> ${data.search_point.lat.toFixed(
            4
          )}, ${data.search_point.lng.toFixed(4)}<br>
          <strong>Radius:</strong> ${data.radius_km} km<br>
          <strong>Found:</strong> ${data.total_found} cities
        </div>
        <div class="list-group list-group-flush">
          ${data.cities
            .map(
              (city) => `
            <div class="list-group-item" onclick="zoomToCity(${city.coordinates.lat}, ${city.coordinates.lng})">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${city.name}</strong><br>
                  <small class="text-muted">${city.country}</small><br>
                  <small>Pop: ${city.population.toLocaleString()}</small>
                </div>
                <span class="distance-badge">${city.distance_km} km</span>
              </div>
            </div>`
            )
            .join("")}
        </div>
        <div class="mt-3">
          <button class="btn btn-sm btn-outline-primary" onclick="exportResults('radius')">
            Export Results
          </button>
        </div>
      `;

      showResults();
    }

    function showResults() {
      const resultsPanel = document.getElementById("results-panel");
      const zoomButton = document.getElementById("zoom-to-results");
      resultsPanel.style.display = "block";
      zoomButton.style.display = "inline-block";
      zoomToResults();
    }

    function zoomToResults() {
      if (resultMarkers.length > 0) {
        const allMarkers = searchMarker
          ? [searchMarker, ...resultMarkers]
          : resultMarkers;
        const group = new L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }

    function zoomToCity(lat, lng) {
      map.setView([lat, lng], 10);
    }

    function clearSearch() {
      if (searchMarker) {
        map.removeLayer(searchMarker);
        searchMarker = null;
      }

      resultMarkers.forEach((marker) => map.removeLayer(marker));
      resultMarkers = [];

      if (radiusCircle) {
        map.removeLayer(radiusCircle);
        radiusCircle = null;
      }

      document.getElementById("results-panel").style.display = "none";
      document.getElementById("zoom-to-results").style.display = "none";
    }

    function showLoadingState(loading) {
      const toggleBtn = document.getElementById("toggle-proximity");
      if (loading) {
        toggleBtn.innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status"></span> Searching...';
        toggleBtn.disabled = true;
      } else {
        toggleBtn.textContent = "Disable Search Mode";
        toggleBtn.disabled = false;
      }
    }

    function showError(message) {
      alert("Error: " + message);
    }

    function exportResults(type) {
      console.log(`Exporting ${type} search results...`);
      alert("Export functionality would be implemented here");
    }

    function getCsrfToken() {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split("=");
        if (name === "csrftoken") {
          return value;
        }
      }
      return "";
    }
  </script>
</body>

</html>
